# 🔓 DeFi Attack Lab

一个基于 Hardhat 的 DeFi 攻防实验平台，包含两个典型攻击案例：

- 🧨 重入攻击（Reentrancy Attack）
- 🧨 预言机操控攻击（Oracle Price Manipulation）

本项目适合网络安全方向学生、智能合约开发者、DeFi 安全研究者进行学习、实验和扩展。

---

# 🌐 DeFi 与以太坊智能合约简介

---

## 🪙 什么是以太坊（Ethereum）？

以太坊是一个开源的、图灵完备的区块链平台，支持**智能合约（Smart Contracts）**。它是一个全球性的去中心化计算平台，允许任何人在其网络上部署无需信任的代码逻辑。

### 核心特性：

- ⛓️ 去中心化网络
- 💡 支持智能合约编程（使用 Solidity 等语言）
- 🌍 广泛用于 DeFi、NFT、DAO、链游等场景

---

## ⚙️ 什么是智能合约？

智能合约是部署在区块链上的自动化程序，可以在满足特定条件时自动执行操作。它们不可更改、可验证、去信任运行。

**示例功能：**

- 自动支付 ETH
- 质押 / 借贷 / 交易执行
- 管理用户资产与规则

智能合约是 DeFi 的核心支柱。

---

## 💸 什么是 DeFi（去中心化金融）？

**DeFi（Decentralized Finance）** 是一系列运行在区块链上的开放金融协议。它不依赖传统金融机构，而是通过智能合约实现交易、借贷、资产管理等服务。

### 常见的 DeFi 协议：

- 去中心化交易所（DEX）如 Uniswap
- 借贷平台如 Aave、Compound
- 衍生品、稳定币、保险协议等

---

## ✅ DeFi 的优势

| 优势             | 说明                                           |
|------------------|------------------------------------------------|
| 无需许可         | 任何人只需拥有钱包地址即可参与               |
| 去中介化         | 无需银行、券商等中介机构                      |
| 自动化执行       | 所有逻辑通过智能合约强制执行                  |
| 开放与透明       | 所有代码公开，数据链上可查                     |
| 可组合性（Lego） | 不同协议之间可以互相集成构建更复杂的金融应用   |

---

## ⚠️ DeFi 的风险

| 风险类型             | 示例与说明                                        |
|----------------------|--------------------------------------------------|
| 智能合约漏洞         | Reentrancy、溢出、访问控制错误等                 |
| 预言机操控风险       | 不可信报价源导致资产价值失真                     |
| 价格操纵与闪电贷攻击 | 利用 AMM 机制+瞬时流动性完成套利                 |
| 设计机制缺陷         | 激励模型不当、清算参数错误等                     |

---

## 🔐 智能合约在 DeFi 中的作用

在 DeFi 中，智能合约负责：

- 管理用户的资产存取与记录
- 计算借贷比例、利息、清算条件
- 与其他合约通信（如预言机、AMM）
- 确保交易流程自动化、不可篡改

这也意味着：**一旦智能合约存在漏洞，攻击者可直接操控系统资产，造成重大损失。**

---

## 🧠 攻击原理解释

### 1. 重入攻击（Reentrancy Attack）

**核心漏洞**：合约在更新用户状态前先执行 `call.value()`，导致攻击合约递归调用，重复提取资金。

攻击流程：

1. 用户存入 ETH 到 `Vault`。
2. 攻击者合约调用 `withdraw()`。
3. `Vault` 调用攻击合约 fallback，攻击者再次发起 `withdraw()`，余额尚未更新，造成多次取款。
4. `Vault` 被掏空。

### 2. 预言机操控攻击（Oracle Manipulation）

**核心漏洞**：Lending 协议依赖一个不可信的 Oracle 合约获取抵押品价格，攻击者可控制价格导致系统高估抵押品价值。

攻击流程：

1. 攻击者将 Oracle 报价人为设置为高价。
2. 存入极少 ETH 抵押，却因高估价值能借出远超抵押价值的 ETH。
3. 攻击合约完成套利。

---

## 🧩 合约功能介绍

### `Vault.sol`

一个简单的 ETH 金库合约，允许用户存款和取款。存在重入攻击漏洞。

### `VaultAttack.sol`

攻击者合约，通过重入方式递归调用目标合约的 `withdraw()`，反复盗取资金。

### `PriceOracle.sol`

一个简化的预言机，允许任意用户设置价格，用于模拟被攻击的场景。

### `LendingProtocol.sol`

一个依赖 Oracle 报价进行抵押借贷的协议，允许用户存入 ETH 作为抵押借出资金。

### `OracleLendingAttack.sol`

攻击者合约，先操控 Oracle 报价为高价，伪造高价值抵押，从协议中借出超额资金。

---

## 🛠️ 本地部署与运行

### 1. 安装依赖

```bash
npm install
```

### 2. 编译合约

```bash
npx hardhat compile
```

### 3. 运行攻击脚本
重入攻击：
```bash
npx hardhat run scripts/runVaultAttack.js
```
预言机攻击：
```bash
npx hardhat run scripts/runOracleLendingAttack.js
```

---

## 📝 免责声明

本项目仅用于教育和研究目的，不构成任何形式的法律建议或保证。使用本项目的合约进行攻击可能导致严重损失，风险由使用者自行承担。

